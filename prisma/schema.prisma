// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== ROLE-BASED ACCESS CONTROL (RBAC) ====================

// Roles (GRCAdministrator, CustomerAdministrator, AuditHead, etc.)
model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  isSystem    Boolean          @default(false) // System roles cannot be deleted
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

// Permissions (resource + action + scope)
model Permission {
  id        String           @id @default(cuid())
  resource  String           // e.g., "organization.process", "risk.register", "audit.dashboard"
  action    String           // e.g., "view", "create", "edit", "delete", "approve"
  scope     String           @default("all") // "all", "department", "own"
  roles     RolePermission[]
  createdAt DateTime         @default(now())

  @@unique([resource, action, scope])
}

// Role-Permission Junction Table
model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
}

// User-Role Junction Table (users can have multiple roles)
model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, roleId])
}

// ==================== ORGANIZATION MODULE ====================

// Organization Profile
model Organization {
  id                 String           @id @default(cuid())
  name               String
  email              String?
  phone              String?
  logo               String?
  establishedDate    String?
  employeeCount      Int              @default(0)
  branchCount        Int              @default(0)
  headOfficeLocation String?
  headOfficeAddress  String?
  website            String?
  description        String?
  vision             String?
  mission            String?
  value              String?
  ceoMessage         String?
  facebook           String?
  youtube            String?
  twitter            String?
  linkedin           String?
  brochure           String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  branches           Branch[]
  dataCenters        DataCenter[]
  cloudProviders     CloudProvider[]
}

// Branch Office
model Branch {
  id             String       @id @default(cuid())
  location       String
  address        String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// Data Center
model DataCenter {
  id             String       @id @default(cuid())
  locationType   String       // On-Prem or Outsourced
  address        String?      // For On-Prem
  vendor         String?      // For Outsourced
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// Cloud Provider
model CloudProvider {
  id             String       @id @default(cuid())
  name           String
  serviceType    String       // Iaas, Paas, Saas
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// Departments
model Department {
  id                    String                 @id @default(cuid())
  name                  String                 @unique
  description           String?
  headId                String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  users                 User[]
  issues                Issue[]
  stakeholders          Stakeholder[]
  controls              Control[]
  processes             Process[]
  policies              Policy[]
  assets                Asset[]
  risks                 Risk[]
  audits                Audit[]
  evidences             Evidence[]
  exceptions            Exception[]
  requirementExceptions RequirementException[]
  kpis                  KPI[]
  internalAuditRisks    InternalAuditRisk[]    @relation("InternalAuditDepartment")
  auditableEntities     AuditableEntity[]
  auditEngagements      AuditEngagement[]
  internalAuditFindings InternalAuditFinding[]
}

// Users
model User {
  id                  String      @id @default(cuid())
  userId              String      @unique
  userName            String      @unique
  email               String      @unique
  password            String
  firstName           String
  lastName            String
  fullName            String
  designation         String?
  function            String?
  role                String      @default("User")
  language            String      @default("English")
  timezone            String      @default("UTC")
  isActive            Boolean     @default(true)
  isBlocked           Boolean     @default(false)
  // CustomerAdmin fields
  customerCode        String?     // Customer account code (e.g., GRC_001)
  logoUrl             String?     // Customer logo URL
  lastLogin           DateTime?   // Last login timestamp
  departmentId        String?
  department          Department? @relation(fields: [departmentId], references: [id])
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  // Relations
  ownedControls       Control[]   @relation("ControlOwner")
  assignedControls    Control[]   @relation("ControlAssignee")
  ownedRisks          Risk[]      @relation("RiskOwner")
  ownedProcesses      Process[]   @relation("ProcessOwner")
  ownedAssets         Asset[]     @relation("AssetOwner")
  custodianAssets     Asset[]     @relation("AssetCustodian")
  assignedEvidences   Evidence[]  @relation("EvidenceAssignee")
  auditor             Audit[]     @relation("Auditor")
  assignedPolicies    Policy[]    @relation("PolicyAssignee")
  approvedPolicies    Policy[]    @relation("PolicyApprover")
  requestedExceptions Exception[] @relation("ExceptionRequester")
  approverExceptions  Exception[] @relation("ExceptionApprover")
  uploadedArtifacts   Artifact[]  @relation("ArtifactUploader")
  // RBAC relations
  userRoles           UserRole[]
  // Internal Audit relations
  assignedEngagements AuditEngagement[]   @relation("EngagementAuditor")
  // Process RACI relations
  responsibleProcesses Process[]          @relation("ProcessResponsible")
  accountableProcesses Process[]          @relation("ProcessAccountable")
  consultedProcesses   Process[]          @relation("ProcessConsulted")
  informedProcesses    Process[]          @relation("ProcessInformed")
}

// Stakeholders
model Stakeholder {
  id           String      @id @default(cuid())
  name         String
  email        String?
  type         String      @default("Internal") // Internal, External, Third Party
  status       String      @default("Active") // Active, Inactive
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Issues
model Issue {
  id           String      @id @default(cuid())
  title        String
  description  String?
  domain       String // Internal, External, IT, GRC
  category     String // Finance, Human Resources, Data breach, etc.
  issueType    String? // Financial, Operational, Compliance, Security, etc.
  status       String      @default("Open") // Open, In Progress, Pending, Resolved, Closed
  dueDate      DateTime?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Services
model Service {
  id              String   @id @default(cuid())
  title           String
  description     String?
  serviceUser     String // Internal, External, Public
  serviceCategory String?
  serviceItem     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================== COMPLIANCE MODULE ====================

// Frameworks
model Framework {
  id                    String                @id @default(cuid())
  name                  String                @unique
  description           String?
  version               String?
  type                  String                @default("Framework") // Framework, Standard, Regulation
  status                String                @default("Subscribed") // Subscribed, Not Subscribed
  country               String?
  industry              String?
  isCustom              Boolean               @default(false)
  logo                  String?
  supportDocumentUrl    String?
  compliancePercentage  Float                 @default(0)
  policyPercentage      Float                 @default(0)
  evidencePercentage    Float                 @default(0)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  controls              Control[]
  evidences             Evidence[]
  requirements          Requirement[]
  requirementCategories RequirementCategory[]
}

// Requirement Categories (Domains/Chapters in a framework)
model RequirementCategory {
  id           String        @id @default(cuid())
  name         String
  code         String?
  description  String?
  sortOrder    Int           @default(0)
  frameworkId  String
  framework    Framework     @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  requirements Requirement[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([frameworkId, name])
}

// Requirements (Framework Requirements with hierarchy)
model Requirement {
  id                   String                 @id @default(cuid())
  code                 String
  name                 String
  description          String?
  requirementType      String                 @default("Mandatory") // Mandatory, Additional
  chapterType          String                 @default("Domain") // Domain, Process Domain, Technical Domain
  sortOrder            Int                    @default(0)
  level                Int                    @default(1) // Hierarchy level: 1=category, 2=requirement, 3=sub-requirement
  parentId             String?
  parent               Requirement?           @relation("RequirementHierarchy", fields: [parentId], references: [id])
  children             Requirement[]          @relation("RequirementHierarchy")
  frameworkId          String
  framework            Framework              @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  categoryId           String?
  category             RequirementCategory?   @relation(fields: [categoryId], references: [id])
  // SOA fields
  applicability        String? // Yes, No
  justification        String?
  implementationStatus String? // Yes, No, Ongoing, N/A
  controlCompliance    String? // Compliant, Non Compliant, Partial Compliant
  // Relations
  controls             RequirementControl[]
  exceptions           RequirementException[]
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  @@unique([frameworkId, code])
}

// Requirement-Control Many-to-Many Junction Table
model RequirementControl {
  id            String      @id @default(cuid())
  requirementId String
  requirement   Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  controlId     String
  control       Control     @relation(fields: [controlId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([requirementId, controlId])
}

// Requirement Exceptions (for compliance exceptions from requirements)
model RequirementException {
  id            String      @id @default(cuid())
  code          String      @unique
  name          String
  description   String?
  category      String      @default("Compliance") // Policy, Control, Compliance, Risk
  requirementId String
  requirement   Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  requesterId   String?
  status        String      @default("Pending") // Pending, Approved, Authorised, Submitted for Closure, Overdue, RiskAccepted, Closed
  endDate       DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// Regulations (legacy - keeping for backwards compatibility)
model Regulation {
  id                     String   @id @default(cuid())
  name                   String   @unique
  version                String?
  sa1Date                String?
  sa2Date                String?
  scope                  String?
  exclusionJustification String?
  document               String?
  certificate            String?
  status                 String   @default("Subscribed") // Subscribed, Not Subscribed
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

// Control Domains
model ControlDomain {
  id        String    @id @default(cuid())
  code      String?
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  controls  Control[]
}

// Controls
model Control {
  id                       String               @id @default(cuid())
  controlCode              String               @unique
  name                     String
  description              String?
  controlQuestion          String?
  functionalGrouping       String? // Govern, Identify, Protect, Detect, Respond, Recover
  status                   String               @default("Non Compliant") // Non Compliant, Compliant, Not Applicable, Partial Compliant
  entities                 String               @default("Organization Wide") // Organization Wide
  isControlList            Boolean              @default(false)
  relativeControlWeighting Int?
  scope                    String? // In-Scope, Not In-Scope
  // CMM Maturity Level Descriptions
  notPerformed             String? // CMM Level 0
  performedInformally      String? // CMM Level 1
  plannedAndTracked        String? // CMM Level 2
  wellDefined              String? // CMM Level 3
  quantitativelyControlled String? // CMM Level 4
  continuouslyImproving    String? // CMM Level 5
  // Relations
  domainId                 String?
  domain                   ControlDomain?       @relation(fields: [domainId], references: [id])
  frameworkId              String?
  framework                Framework?           @relation(fields: [frameworkId], references: [id])
  departmentId             String?
  department               Department?          @relation(fields: [departmentId], references: [id])
  ownerId                  String?
  owner                    User?                @relation("ControlOwner", fields: [ownerId], references: [id])
  assigneeId               String?
  assignee                 User?                @relation("ControlAssignee", fields: [assigneeId], references: [id])
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  evidences                Evidence[]
  exceptions               Exception[]
  requirements             RequirementControl[]
  controlRisks             ControlRisk[]
  policyControls           PolicyControl[]
  evidenceControls         EvidenceControl[]      @relation("EvidenceControls")
}

// Processes
model Process {
  id                     String       @id @default(cuid())
  processCode            String       @unique
  name                   String
  description            String?
  processType            String       @default("Primary") // Primary, Management, Supporting
  departmentId           String?
  department             Department?  @relation(fields: [departmentId], references: [id])
  ownerId                String?
  owner                  User?        @relation("ProcessOwner", fields: [ownerId], references: [id])
  status                 String       @default("Active")
  // Audit Library fields
  processFrequency       String?      // Annually, As needed, Bi-annually, Daily, monthly, Monthly, Quarterly, Weekly
  natureOfImplementation String?      // Manual, Automated, Manual + Automated
  riskRating             String?      // Low, Medium, High, Not Assessed
  assetDependency        Boolean      @default(false)
  externalDependency     Boolean      @default(false)
  location               String?      // JSON array of locations
  kpiMeasurementRequired Boolean      @default(false)
  piiCapture             Boolean      @default(false)
  operationalComplexity  String?      // Low, Medium, High
  lastAuditDate          DateTime?
  // RACI fields
  responsibleId          String?
  responsible            User?        @relation("ProcessResponsible", fields: [responsibleId], references: [id])
  accountableId          String?
  accountable            User?        @relation("ProcessAccountable", fields: [accountableId], references: [id])
  consultedId            String?
  consulted              User?        @relation("ProcessConsulted", fields: [consultedId], references: [id])
  informedId             String?
  informed               User?        @relation("ProcessInformed", fields: [informedId], references: [id])
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  // BIA Relation
  biaAssessment          ProcessBIA?
}

// ==================== BUSINESS IMPACT ANALYSIS (BIA) ====================

// BIA Impact Categories (Financial, Reputational, Regulatory, Safety, Operational)
model BIACategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// BIA Rating Methodology (defines the rating levels and their scores)
model BIARating {
  id          String   @id @default(cuid())
  label       String   @unique // High, Medium, Low
  score       Int      @default(0) // Score value for calculations
  description String?  // Description of what this rating means
  color       String?  // Color code for UI display
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// BIA Scoring Configuration (High of All, Addition of All, Product of All)
model BIAScoringConfig {
  id              String   @id @default(cuid())
  calculationType String   @default("High of all") // High of all, Addition of all, Product of all
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// BIA Scoring Ranges (defines criticality levels based on scores)
model BIAScoringRange {
  id              String   @id @default(cuid())
  label           String   // Critical, High, Medium, Low
  lowValue        Int      @default(0)
  highValue       Int?
  color           String?  // Color code for UI display
  calculationType String   @default("High of all") // Links to the scoring config
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([label, calculationType])
}

// BCP Labels (Business Continuity Planning labels for RTO/RPO)
model BCPLabel {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String   // RTO, RPO
  hours       Int      @default(0) // Value in hours
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Process BIA Assessment (stores the BIA assessment for each process)
model ProcessBIA {
  id                 String              @id @default(cuid())
  processId          String              @unique
  process            Process             @relation(fields: [processId], references: [id], onDelete: Cascade)
  // BIA Status
  status             String              @default("Open") // Open, Pending Approval, Approved, Rejected
  // Calculated values
  impactRating       Int?                // Calculated based on scoring config
  processCriticality String?             // Critical, High, Medium, Low (derived from scoring ranges)
  // Recovery objectives
  rtoHours           Int                 @default(0) // Recovery Time Objective in hours
  rpoHours           Int                 @default(0) // Recovery Point Objective in hours
  rtoLabel           String?             // Label for RTO
  rpoLabel           String?             // Label for RPO
  // Approver
  approverId         String?
  approverName       String?
  approvedAt         DateTime?
  // Comments
  comments           String?
  rejectionReason    String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  // Category ratings
  categoryRatings    ProcessBIARating[]
}

// Process BIA Category Ratings (individual category ratings for a process)
model ProcessBIARating {
  id            String     @id @default(cuid())
  processBIAId  String
  processBIA    ProcessBIA @relation(fields: [processBIAId], references: [id], onDelete: Cascade)
  categoryName  String     // Financial, Reputational, Regulatory, Safety, Operational
  rating        String?    // High, Medium, Low
  ratingScore   Int?       // Score value
  description   String?    // Impact description
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([processBIAId, categoryName])
}

// Governance - Policies, Standards, Procedures
model Policy {
  id                    String             @id @default(cuid())
  code                  String             @unique
  name                  String
  version               String             @default("1.0")
  documentType          String             @default("Policy") // Policy, Standard, Procedure
  recurrence            String? // Weekly, Monthly, Quarterly, Yearly
  departmentId          String?
  department            Department?        @relation(fields: [departmentId], references: [id])
  assigneeId            String?
  assignee              User?              @relation("PolicyAssignee", fields: [assigneeId], references: [id])
  approverId            String?
  approver              User?              @relation("PolicyApprover", fields: [approverId], references: [id])
  status                String             @default("Not Uploaded") // Not Uploaded, Draft, Approved, Needs Review, Published, Pending Approval
  effectiveDate         DateTime?
  reviewDate            DateTime?
  content               String?
  // AI Review Fields
  aiReviewStatus        String?            @default("Pending") // Pending, In Progress, Completed
  aiReviewScore         Float?             @default(0)
  aiReviewJustification String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  attachments           PolicyAttachment[]
  policyControls        PolicyControl[]
  policyExceptions      PolicyException[]
  exceptions            Exception[]        @relation("PolicyExceptions")
}

// Evidence
model Evidence {
  id                    String               @id @default(cuid())
  evidenceCode          String               @unique
  name                  String
  description           String?
  domain                String? // Compliance, Change Management, Education, Risk Management, etc.
  frameworkId           String?
  framework             Framework?           @relation(fields: [frameworkId], references: [id])
  controlId             String? // Legacy single control reference
  control               Control?             @relation(fields: [controlId], references: [id])
  departmentId          String?
  department            Department?          @relation(fields: [departmentId], references: [id])
  assigneeId            String?
  assignee              User?                @relation("EvidenceAssignee", fields: [assigneeId], references: [id])
  dueDate               DateTime?
  reviewDate            DateTime?
  recurrence            String? // Yearly, Half-yearly, Quarterly, Monthly
  status                String               @default("Not Uploaded") // Not Uploaded, Draft, Validated, Published, Need Attention
  publishedAt           DateTime?
  // KPI fields
  kpiRequired           Boolean              @default(false)
  kpiObjective          String?
  kpiDataSource         String?
  kpiExpectedScore      Float?
  kpiDescription        String?
  kpiCalculationFormula String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  attachments           EvidenceAttachment[]
  kpis                  KPI[]
  evidenceControls      EvidenceControl[]
  linkedArtifacts       EvidenceArtifact[]
}

// Evidence-Control Many-to-Many Junction Table
model EvidenceControl {
  id         String   @id @default(cuid())
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  controlId  String
  control    Control  @relation("EvidenceControls", fields: [controlId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([evidenceId, controlId])
}

// Standalone Artifact for the Artifacts tab
model Artifact {
  id              String            @id @default(cuid())
  artifactCode    String            @unique
  name            String
  fileName        String
  fileType        String? // pdf, docx, xlsx, png, jpg, etc.
  fileSize        Int?
  filePath        String
  uploadedBy      String?
  uploadedById    String?
  uploader        User?             @relation("ArtifactUploader", fields: [uploadedById], references: [id])
  aiReviewStatus  String? // Pending, Reviewed
  aiReviewScore   Float?
  aiReviewNotes   String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  linkedEvidences EvidenceArtifact[]
}

// Evidence-Artifact Many-to-Many Junction Table
model EvidenceArtifact {
  id         String   @id @default(cuid())
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  artifactId String
  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([evidenceId, artifactId])
}

// Exceptions
model Exception {
  id               String             @id @default(cuid())
  exceptionCode    String             @unique
  name             String
  description      String? // Reason For Exception
  category         String // Policy, Control, Compliance, Risk
  departmentId     String?
  department       Department?        @relation(fields: [departmentId], references: [id])
  // Category-specific references
  controlId        String?
  control          Control?           @relation(fields: [controlId], references: [id])
  policyId         String?
  policy           Policy?            @relation("PolicyExceptions", fields: [policyId], references: [id])
  riskId           String?
  risk             Risk?              @relation("RiskExceptions", fields: [riskId], references: [id])
  // Requester and Approver
  requesterId      String?
  requester        User?              @relation("ExceptionRequester", fields: [requesterId], references: [id])
  approverId       String?
  approver         User?              @relation("ExceptionApprover", fields: [approverId], references: [id])
  // Approval details
  approvedBy       String? // Name of person who approved
  approvedDate     DateTime?
  // Status and dates
  status           String             @default("Pending") // Pending, Approved, Authorised, Submitted for Closure, Overdue, RiskAccepted, Closed
  startDate        DateTime?
  endDate          DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  // Relations
  comments         ExceptionComment[]
  policyExceptions PolicyException[]
}

// Exception Comments
model ExceptionComment {
  id          String    @id @default(cuid())
  content     String
  exceptionId String
  exception   Exception @relation(fields: [exceptionId], references: [id], onDelete: Cascade)
  userId      String?
  userName    String? // Store username at time of comment
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// KPI (Key Performance Indicators)
model KPI {
  id                 String      @id @default(cuid())
  code               String      @unique
  objective          String? // KPI Objective
  description        String? // KPI Description
  dataSource         String? // KPI Data Source
  calculationFormula String? // KPI Calculation Formula
  expectedScore      Float? // Expected Score
  actualScore        Float? // Current Actual Score
  reviewDate         DateTime? // Next Review Date
  status             String      @default("Scheduled") // Scheduled, Missed, Overdue, Achieved
  departmentId       String?
  department         Department? @relation(fields: [departmentId], references: [id])
  evidenceId         String?
  evidence           Evidence?   @relation(fields: [evidenceId], references: [id])
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  // KPI Review History
  reviews            KPIReview[]
}

// KPI Review History (tracks actual score submissions over time)
model KPIReview {
  id           String          @id @default(cuid())
  reviewDate   DateTime
  actualScore  Float?
  status       String          @default("Scheduled") // Scheduled, Missed, Overdue, Achieved
  documentPath String? // Path to uploaded document
  documentName String? // Name of uploaded document
  kpiId        String
  kpi          KPI             @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  actionPlans  KPIActionPlan[]
}

// KPI Action Plan (for remediation when KPI is missed)
model KPIActionPlan {
  id                  String    @id @default(cuid())
  plannedAction       String // Required: The planned action to take
  description         String? // Optional: Detailed description
  percentageCompleted Float     @default(0) // Required: 0-100
  startDate           DateTime? // Required: When the action starts
  status              String    @default("In-Progress") // Open, In-Progress, Completed
  kpiReviewId         String
  kpiReview           KPIReview @relation(fields: [kpiReviewId], references: [id], onDelete: Cascade)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// Policy Attachments (Governance document files)
model PolicyAttachment {
  id         String   @id @default(cuid())
  fileName   String
  fileType   String? // pdf, docx, xlsx, etc.
  fileSize   Int?
  filePath   String
  uploadedAt DateTime @default(now())
  policyId   String
  policy     Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Evidence Attachments (Artifacts)
model EvidenceAttachment {
  id         String   @id @default(cuid())
  fileName   String
  fileType   String? // pdf, docx, xlsx, png, jpg, etc.
  fileSize   Int?
  filePath   String
  uploadedAt DateTime @default(now())
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Policy-Control Many-to-Many Junction Table
model PolicyControl {
  id        String   @id @default(cuid())
  policyId  String
  policy    Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  controlId String
  control   Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([policyId, controlId])
}

// Control-Risk Many-to-Many Junction Table
model ControlRisk {
  id        String   @id @default(cuid())
  controlId String
  control   Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  riskId    String
  risk      Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([controlId, riskId])
}

// Policy-Exception Many-to-Many Junction Table
model PolicyException {
  id          String    @id @default(cuid())
  policyId    String
  policy      Policy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  exceptionId String
  exception   Exception @relation(fields: [exceptionId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())

  @@unique([policyId, exceptionId])
}

// ==================== ASSET MANAGEMENT MODULE ====================

// Asset Category (Top-level categories: Hardware, Software, Data, etc.)
model AssetCategory {
  id            String             @id @default(cuid())
  name          String             @unique
  description   String?
  status        String             @default("Active") // Active, Inactive
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  subCategories AssetSubCategory[]
  assets        Asset[]
}

// Asset Sub Category (e.g., Server, Firewall under Hardware)
model AssetSubCategory {
  id                      String                   @id @default(cuid())
  name                    String
  description             String?
  categoryId              String
  category                AssetCategory            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  status                  String                   @default("Active") // Active, Inactive
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  assets                  Asset[]
  assetCIAClassifications AssetCIAClassification[]

  @@unique([name, categoryId])
}

// Asset Group (Logical groupings: Security Tools, Payment Systems, etc.)
model AssetGroup {
  id                      String                   @id @default(cuid())
  name                    String                   @unique
  description             String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  assets                  Asset[]
  assetCIAClassifications AssetCIAClassification[]
}

// CIA Rating Levels (for Confidentiality, Integrity, Availability)
model CIARating {
  id        String   @id @default(cuid())
  type      String   // Confidentiality, Integrity, Availability
  label     String   // high, medium, low
  value     Int      // Score value (e.g., 10, 5, 1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, label])
}

// Asset Sensitivity Levels
model AssetSensitivity {
  id          String   @id @default(cuid())
  name        String   @unique // Public, Internal, Confidential, Restricted
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]
}

// Asset CIA Classification (Links Sub Category + Group with CIA ratings)
model AssetCIAClassification {
  id                    String           @id @default(cuid())
  subCategoryId         String
  subCategory           AssetSubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)
  groupId               String
  group                 AssetGroup       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  confidentiality       String           @default("low") // high, medium, low
  confidentialityScore  Int              @default(1)
  integrity             String           @default("low") // high, medium, low
  integrityScore        Int              @default(1)
  availability          String           @default("low") // high, medium, low
  availabilityScore     Int              @default(0)
  assetCriticality      String           @default("low") // high, medium, low
  assetCriticalityScore Int              @default(1)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([subCategoryId, groupId])
}

// Asset Lifecycle Status
model AssetLifecycleStatus {
  id          String   @id @default(cuid())
  name        String   @unique // Active, In Use, Needs Maintenance, Retired
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]
}

// Asset Classification (Legacy - keeping for backwards compatibility)
model AssetClassification {
  id          String   @id @default(cuid())
  name        String   @unique // Critical, High, Medium, Low
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]
}

// Assets
model Asset {
  id                String                @id @default(cuid())
  assetId           String                @unique
  name              String
  description       String?
  // Category hierarchy
  categoryId        String?
  category          AssetCategory?        @relation(fields: [categoryId], references: [id])
  subCategoryId     String?
  subCategory       AssetSubCategory?     @relation(fields: [subCategoryId], references: [id])
  groupId           String?
  group             AssetGroup?           @relation(fields: [groupId], references: [id])
  // Legacy asset type (keeping for backwards compatibility)
  assetType         String?               // Hardware, Software, Information, People, Services, Facility
  // Department and ownership
  departmentId      String?
  department        Department?           @relation(fields: [departmentId], references: [id])
  ownerId           String?
  owner             User?                 @relation("AssetOwner", fields: [ownerId], references: [id])
  custodianId       String?
  custodian         User?                 @relation("AssetCustodian", fields: [custodianId], references: [id])
  // Classification
  classificationId  String?
  classification    AssetClassification?  @relation(fields: [classificationId], references: [id])
  sensitivityId     String?
  sensitivity       AssetSensitivity?     @relation(fields: [sensitivityId], references: [id])
  // Lifecycle
  lifecycleStatusId String?
  lifecycleStatus   AssetLifecycleStatus? @relation(fields: [lifecycleStatusId], references: [id])
  status            String                @default("Active") // Legacy status field
  // Asset details
  value             Float?
  location          String?
  acquisitionDate   DateTime?
  nextReviewDate    DateTime?
  // Timestamps
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
}

// ==================== RISK MANAGEMENT MODULE ====================

// Risk Categories
model RiskCategory {
  id          String   @id @default(cuid())
  name        String   @unique // Strategic, Operational, Financial, Compliance, IT/Cyber, Reputational
  description String?
  color       String?  // Color code for UI display
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       Risk[]
}

// Risk Types
model RiskType {
  id          String   @id @default(cuid())
  name        String   @unique // Inherent, Residual, Target
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       Risk[]
}

// Risk Threats
model RiskThreat {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       RiskThreatMapping[]
}

// Risk Vulnerabilities
model RiskVulnerability {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       RiskVulnerabilityMapping[]
}

// Risk Causes
model RiskCause {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       RiskCauseMapping[]
}

// Risk-Threat Mapping (many-to-many)
model RiskThreatMapping {
  id        String     @id @default(cuid())
  riskId    String
  risk      Risk       @relation(fields: [riskId], references: [id], onDelete: Cascade)
  threatId  String
  threat    RiskThreat @relation(fields: [threatId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([riskId, threatId])
}

// Risk-Vulnerability Mapping (many-to-many)
model RiskVulnerabilityMapping {
  id              String            @id @default(cuid())
  riskId          String
  risk            Risk              @relation(fields: [riskId], references: [id], onDelete: Cascade)
  vulnerabilityId String
  vulnerability   RiskVulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
  createdAt       DateTime          @default(now())

  @@unique([riskId, vulnerabilityId])
}

// Risk-Cause Mapping (many-to-many)
model RiskCauseMapping {
  id        String    @id @default(cuid())
  riskId    String
  risk      Risk      @relation(fields: [riskId], references: [id], onDelete: Cascade)
  causeId   String
  cause     RiskCause @relation(fields: [causeId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())

  @@unique([riskId, causeId])
}

// Risks
model Risk {
  id                  String        @id @default(cuid())
  riskId              String        @unique
  name                String
  description         String?
  riskSources         String?       // Sources of the risk
  categoryId          String?
  category            RiskCategory? @relation(fields: [categoryId], references: [id])
  typeId              String?
  type                RiskType?     @relation(fields: [typeId], references: [id])
  departmentId        String?
  department          Department?   @relation(fields: [departmentId], references: [id])
  ownerId             String?
  owner               User?         @relation("RiskOwner", fields: [ownerId], references: [id])
  // Assessment scores
  likelihood          Int           @default(1) // 1-5 scale
  impact              Int           @default(1) // 1-5 scale
  riskScore           Int           @default(1) // likelihood * impact
  riskRating          String        @default("Low") // Catastrophic, Very High, High, Medium, Low
  // Inherent, Residual, Target risk scores
  inherentLikelihood  Int?
  inherentImpact      Int?
  inherentRiskScore   Int?
  residualLikelihood  Int?
  residualImpact      Int?
  residualRiskScore   Int?
  targetLikelihood    Int?
  targetImpact        Int?
  targetRiskScore     Int?
  // Response
  status              String        @default("Open") // Awaiting Approval, Pending Assessment, Open, In Progress, Closed
  responseStrategy    String?       // Treat, Transfer, Avoid, Accept
  treatmentPlan       String?
  treatmentDueDate    DateTime?
  treatmentStatus     String?       // Not Started, In Progress, Completed
  // Timestamps
  identifiedDate      DateTime      @default(now())
  lastAssessmentDate  DateTime?
  nextReviewDate      DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  // Relations
  threats             RiskThreatMapping[]
  vulnerabilities     RiskVulnerabilityMapping[]
  causes              RiskCauseMapping[]
  assessments         RiskAssessment[]
  responses           RiskResponse[]
  activityLogs        RiskActivityLog[]
  controlRisks        ControlRisk[]
  exceptions          Exception[]   @relation("RiskExceptions")
}

// Risk Assessment Records
model RiskAssessment {
  id                 String   @id @default(cuid())
  assessmentId       String   @unique
  riskId             String
  risk               Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  assessmentType     String   @default("Periodic") // Initial, Periodic, Ad-hoc
  assessorName       String?
  // Assessment scores
  likelihood         Int      @default(1)
  likelihoodRationale String?
  impact             Int      @default(1)
  impactRationale    String?
  riskScore          Int      @default(1)
  riskRating         String   @default("Low")
  // Identified items during assessment
  threatsIdentified  String?  // JSON array of threat names
  vulnerabilitiesIdentified String? // JSON array of vulnerability names
  causesIdentified   String?  // JSON array of cause names
  // Recommendations
  recommendations    String?
  notes              String?
  // Status
  status             String   @default("Draft") // Draft, Submitted, Approved, Rejected
  assessmentDate     DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Risk Response Records
model RiskResponse {
  id               String    @id @default(cuid())
  responseId       String    @unique
  riskId           String
  risk             Risk      @relation(fields: [riskId], references: [id], onDelete: Cascade)
  responseType     String    @default("Mitigate") // Mitigate, Transfer, Accept, Avoid
  actionTitle      String
  actionDescription String?
  assignee         String?
  dueDate          DateTime?
  status           String    @default("Open") // Open, In Progress, Completed, Overdue
  completionDate   DateTime?
  effectivenessRating Int?   // 1-5 scale
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// Risk Settings (configurable parameters)
model RiskSetting {
  id          String   @id @default(cuid())
  category    String   // likelihood_scale, impact_scale, rating_matrix, appetite, frequency
  key         String
  value       String   // JSON value
  label       String?
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([category, key])
}

// Risk Activity Log (for tracking all risk-related activities)
model RiskActivityLog {
  id          String   @id @default(cuid())
  riskId      String
  risk        Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  activity    String   // Created, Updated, Deleted, Status Changed, Assessment Added, etc.
  description String?  // Detailed description of what changed
  actor       String   // User who performed the action
  actorId     String?  // User ID if available
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())
}

// ==================== INTERNAL AUDIT MODULE ====================

// Legacy Audits (keeping for backwards compatibility)
model Audit {
  id           String         @id @default(cuid())
  auditId      String         @unique
  name         String
  description  String?
  auditType    String? // Internal, External
  departmentId String?
  department   Department?    @relation(fields: [departmentId], references: [id])
  auditorId    String?
  auditor      User?          @relation("Auditor", fields: [auditorId], references: [id])
  status       String         @default("Planned") // Planned, In Progress, Completed, Cancelled
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  findings     AuditFinding[]
}

// Audit Findings
model AuditFinding {
  id          String   @id @default(cuid())
  findingId   String   @unique
  title       String
  description String?
  auditId     String?
  audit       Audit?   @relation(fields: [auditId], references: [id])
  severity    String   @default("Medium") // High, Medium, Low
  status      String   @default("Open") // Open, In Progress, Closed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  capas       CAPA[]
}

// CAPA (Corrective and Preventive Actions)
model CAPA {
  id          String        @id @default(cuid())
  capaId      String        @unique
  title       String
  description String?
  findingId   String?
  finding     AuditFinding? @relation(fields: [findingId], references: [id])
  actionType  String        @default("Corrective") // Corrective, Preventive
  status      String        @default("Open") // Open, In Progress, Closed, Overdue
  dueDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// ==================== INTERNAL AUDIT SETTINGS ====================

// Audit Category (e.g., Financial Audit, Operational Audit, Compliance Audit)
model AuditCategory {
  id                  String              @id @default(cuid())
  name                String              @unique
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  internalAuditRisks  InternalAuditRisk[]
}

// Nature of Controls (e.g., Preventive, Detective, Corrective)
model AuditNatureOfControl {
  id        String   @id @default(cuid())
  label     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Risk Factors for Internal Audit (e.g., Financial, Reputational, Regulatory)
model AuditRiskFactor {
  id        String   @id @default(cuid())
  label     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Probability ratings (e.g., Very Low=1, Low=2, Medium=3, High=4, Very High=5)
model AuditProbability {
  id        String   @id @default(cuid())
  label     String   @unique
  value     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Impact ratings (e.g., Very Low Probability=1, Low Probability=2, etc.)
model AuditImpact {
  id        String   @id @default(cuid())
  label     String   @unique
  value     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Scoring Range Configuration (e.g., High: 250+, Medium: 100-249, Low: 50-99)
model AuditScoringRange {
  id              String   @id @default(cuid())
  label           String
  lowValue        Int      @default(0)
  highValue       Int?
  calculationType String   @default("High of all") // High of all, Addition of all, Product of all
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([label, calculationType])
}

// Audit Scoring Configuration (stores the calculation type settings)
model AuditScoringConfig {
  id                        String   @id @default(cuid())
  probabilityImpactCalcType String   @default("Product of all") // High of all, Addition of all, Product of all
  riskRatingCalcType        String   @default("High of all") // High of all, Addition of all, Product of all
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// Periodicity (e.g., Annual=12, Semiannual=6, Monthly=1)
model AuditPeriodicity {
  id        String   @id @default(cuid())
  interval  String   @unique
  months    Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Escalation Configuration (reminder days for various events)
model AuditEscalationConfig {
  id                  String   @id @default(cuid())
  responseSubmission  Int      @default(5)
  acknowledgement     Int      @default(1)
  clarification       Int      @default(2)
  issueResolution     Int      @default(3)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// Audit Type (e.g., Consult, Assurance, Follow-up)
model AuditType {
  id                  String              @id @default(cuid())
  name                String              @unique
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  internalAuditRisks  InternalAuditRisk[]
  engagements         AuditEngagement[]   @relation("EngagementAuditType")
}

// ==================== INTERNAL AUDIT RISK REGISTER ====================

// Internal Audit Risk (separate from general Risk for the Internal Audit module)
model InternalAuditRisk {
  id                   String         @id @default(cuid())
  riskId               String         @unique // Auto-generated RID001, RID002, etc.
  riskName             String
  departmentId         String?
  department           Department?    @relation("InternalAuditDepartment", fields: [departmentId], references: [id])
  sectionProcess       String?
  subProcess           String?
  activity             String?
  categoryId           String?
  category             AuditCategory? @relation(fields: [categoryId], references: [id])
  auditTypeId          String?
  auditType            AuditType?     @relation(fields: [auditTypeId], references: [id])
  riskDescription      String?
  // Inherent Risk Scoring
  inherentLikelihood   Int?
  inherentImpact       Int?
  inherentScore        Int?           // Calculated: likelihood * impact or based on config
  // Controls
  controlDescription   String?
  controlEffectiveness String?        // Effective, Partially Effective, Ineffective
  // Residual Risk Scoring
  residualLikelihood   Int?
  residualImpact       Int?
  residualScore        Int?           // Calculated
  riskLevel            String?        // Low, Medium, High, Extreme - based on scoring ranges
  // Audit Information
  creationDate         DateTime       @default(now())
  auditComment         String?
  status               String         @default("Open") // Open, Closed, Under Review
  evidenceFilePath     String?
  evidenceFileName     String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
}

// ==================== INTERNAL AUDIT - AUDIT UNIVERSE ====================

// Auditable Entity (items within departments that can be audited)
model AuditableEntity {
  id              String            @id @default(cuid())
  entityCode      String            @unique
  name            String
  description     String?
  departmentId    String
  department      Department        @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  plannedHours    Float             @default(0)
  actualHours     Float             @default(0)
  lastAuditDate   DateTime?
  nextAuditDate   DateTime?
  riskRating      String?           // Low, Medium, High
  status          String            @default("Active") // Active, Inactive
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  engagements     AuditEngagement[]
}

// ==================== INTERNAL AUDIT - AUDIT PLANNING ====================

// Audit Engagement (Annual Audit Plan items)
model AuditEngagement {
  id                String           @id @default(cuid())
  auditId           String           @unique // Auto-generated AUD001, AUD002
  engagementTitle   String
  description       String?
  departmentId      String?
  department        Department?      @relation(fields: [departmentId], references: [id])
  auditableEntityId String?
  auditableEntity   AuditableEntity? @relation(fields: [auditableEntityId], references: [id])
  auditTypeId       String?
  auditType         AuditType?       @relation("EngagementAuditType", fields: [auditTypeId], references: [id])
  assignedAuditorId String?
  assignedAuditor   User?            @relation("EngagementAuditor", fields: [assignedAuditorId], references: [id])
  // Planning dates
  plannedStartDate  DateTime?
  plannedEndDate    DateTime?
  actualStartDate   DateTime?
  actualEndDate     DateTime?
  // Hours
  plannedHours      Float            @default(0)
  actualHours       Float            @default(0)
  // Status
  status            String           @default("Planned") // Planned, In Progress, Completed, Cancelled
  priority          String           @default("Medium") // Low, Medium, High
  year              Int              @default(2026)
  quarter           String?          // Q1, Q2, Q3, Q4
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  // Relations
  fieldwork         AuditFieldwork?
  report            AuditReport?
  findings          InternalAuditFinding[]
}

// ==================== INTERNAL AUDIT - FIELDWORK ====================

// Audit Fieldwork (execution of audit engagement)
model AuditFieldwork {
  id              String          @id @default(cuid())
  engagementId    String          @unique
  engagement      AuditEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)
  // Execution details
  startDate       DateTime?
  targetDate      DateTime?
  completionDate  DateTime?
  // Status
  status          String          @default("Not Started") // Not Started, In Progress, Review, Completed
  // Work details
  scope           String?
  objectives      String?
  methodology     String?
  observations    String?
  // Hours tracking
  hoursSpent      Float           @default(0)
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  workpapers      AuditWorkpaper[]
}

// Audit Workpapers (supporting documents for fieldwork)
model AuditWorkpaper {
  id           String         @id @default(cuid())
  fieldworkId  String
  fieldwork    AuditFieldwork @relation(fields: [fieldworkId], references: [id], onDelete: Cascade)
  fileName     String
  fileType     String?
  fileSize     Int?
  filePath     String
  description  String?
  uploadedBy   String?
  uploadedAt   DateTime       @default(now())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

// ==================== INTERNAL AUDIT - REPORTS ====================

// Audit Report
model AuditReport {
  id                  String          @id @default(cuid())
  reportCode          String          @unique // Auto-generated RPT001, RPT002
  engagementId        String          @unique
  engagement          AuditEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)
  // Report content
  title               String
  executiveSummary    String?
  scope               String?
  objectives          String?
  methodology         String?
  observations        String?
  recommendations     String?
  managementResponse  String?
  conclusion          String?
  // Status
  status              String          @default("Draft") // Draft, Review, Final, Published
  draftGeneratedAt    DateTime?
  reviewedAt          DateTime?
  publishedAt         DateTime?
  reviewedBy          String?
  // Attachment
  reportFilePath      String?
  reportFileName      String?
  // Timestamps
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
}

// ==================== INTERNAL AUDIT - FINDINGS & CAPA ====================

// Internal Audit Finding (linked to engagement, separate from general AuditFinding)
model InternalAuditFinding {
  id                 String                @id @default(cuid())
  findingId          String                @unique // Auto-generated FND001, FND002
  engagementId       String
  engagement         AuditEngagement       @relation(fields: [engagementId], references: [id], onDelete: Cascade)
  // Finding details
  finding            String
  description        String?
  severity           String                @default("Medium") // Low, Medium, High
  departmentId       String?
  department         Department?           @relation(fields: [departmentId], references: [id])
  responsiblePerson  String?
  responsiblePersonId String?
  // Dates
  identifiedDate     DateTime              @default(now())
  targetDate         DateTime?
  closedDate         DateTime?
  // Status
  status             String                @default("Open") // Open, In Progress, Closed, Overdue
  // Timestamps
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  // Relations
  capas              InternalAuditCAPA[]
}

// Internal Audit CAPA (Corrective and Preventive Actions for internal audit findings)
model InternalAuditCAPA {
  id              String                @id @default(cuid())
  capaId          String                @unique // Auto-generated CAPA001, CAPA002
  findingId       String
  finding         InternalAuditFinding  @relation(fields: [findingId], references: [id], onDelete: Cascade)
  // CAPA details
  title           String
  description     String?
  actionType      String                @default("Corrective") // Corrective, Preventive
  responsiblePerson String?
  // Dates
  targetDate      DateTime?
  completedDate   DateTime?
  // Status
  status          String                @default("Open") // Open, In Progress, Closed, Overdue
  // Evidence
  evidenceFilePath String?
  evidenceFileName String?
  // Timestamps
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

// ==================== INTERNAL AUDIT - DOCUMENT LIBRARY ====================

// Internal Audit Document (for document library)
model InternalAuditDocument {
  id           String   @id @default(cuid())
  documentCode String   @unique
  name         String
  description  String?
  category     String   @default("Policy") // Policy, Regulation, Previous Report
  fileName     String
  fileType     String?
  fileSize     Int?
  filePath     String
  uploadedBy   String?
  uploadedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==================== GOVERNANCE TEMPLATES ====================

// Governance Templates (Policy, Standard, Procedure templates)
model GovernanceTemplate {
  id             String   @id @default(cuid())
  name           String
  governanceType String   @default("Policy") // Policy, Standard, Procedure
  fileName       String
  fileType       String? // pdf, docx, xlsx, etc.
  fileSize       Int?
  filePath       String
  uploadedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ==================== AUDIT LOGS ====================

model AuditLog {
  id         String   @id @default(cuid())
  changeType String // CREATE, UPDATE, DELETE
  entityType String // e.g., Control, User, Risk
  entityId   String
  userId     String?
  userName   String?
  changes    String? // JSON string of old/new values
  createdAt  DateTime @default(now())
}
