// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== ORGANIZATION MODULE ====================

// Organization Profile
model Organization {
  id                 String   @id @default(cuid())
  name               String
  establishedDate    String?
  employeeCount      Int      @default(0)
  branchCount        Int      @default(0)
  headOfficeLocation String?
  headOfficeAddress  String?
  website            String?
  description        String?
  vision             String?
  mission            String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Departments
model Department {
  id           String        @id @default(cuid())
  name         String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  users        User[]
  issues       Issue[]
  stakeholders Stakeholder[]
  controls     Control[]
  processes    Process[]
  policies     Policy[]
  assets       Asset[]
  audits       Audit[]
  evidences    Evidence[]
  exceptions   Exception[]
}

// Users
model User {
  id           String      @id @default(cuid())
  userName     String      @unique
  email        String      @unique
  password     String
  firstName    String
  lastName     String
  fullName     String
  designation  String?
  function     String?
  role         String      @default("User")
  language     String      @default("English")
  timezone     String      @default("UTC")
  isActive     Boolean     @default(true)
  isBlocked    Boolean     @default(false)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  // Relations
  ownedControls    Control[]    @relation("ControlOwner")
  assignedControls Control[]    @relation("ControlAssignee")
  ownedProcesses   Process[]    @relation("ProcessOwner")
  ownedAssets      Asset[]      @relation("AssetOwner")
  custodianAssets  Asset[]      @relation("AssetCustodian")
  assignedEvidences Evidence[]  @relation("EvidenceAssignee")
  auditor          Audit[]      @relation("Auditor")
}

// Stakeholders
model Stakeholder {
  id           String      @id @default(cuid())
  name         String
  email        String?
  type         String      @default("Internal") // Internal, External, Third Party
  status       String      @default("Active") // Active, Inactive
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Issues
model Issue {
  id           String      @id @default(cuid())
  title        String
  description  String?
  domain       String // Internal, External, IT, GRC
  category     String // Finance, Human Resources, Data breach, etc.
  status       String      @default("Open") // Open, In Progress, Pending, Resolved, Closed
  dueDate      DateTime?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Services
model Service {
  id              String   @id @default(cuid())
  title           String
  description     String?
  serviceUser     String // Internal, External, Public
  serviceCategory String?
  serviceItem     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================== COMPLIANCE MODULE ====================

// Frameworks
model Framework {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  version     String?
  status      String    @default("Subscribed") // Subscribed, Not Subscribed
  logo        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  controls    Control[]
  evidences   Evidence[]
}

// Regulations (legacy - keeping for backwards compatibility)
model Regulation {
  id        String   @id @default(cuid())
  name      String   @unique
  status    String   @default("Subscribed") // Subscribed, Not Subscribed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Control Domains
model ControlDomain {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  controls  Control[]
}

// Controls
model Control {
  id                String         @id @default(cuid())
  controlCode       String         @unique
  name              String
  description       String?
  controlQuestion   String?
  functionalGrouping String?       // Govern, Identify, Protect, Detect, Respond, Recover
  status            String         @default("Non Compliant") // Non Compliant, Compliant, Not Applicable
  domainId          String?
  domain            ControlDomain? @relation(fields: [domainId], references: [id])
  frameworkId       String?
  framework         Framework?     @relation(fields: [frameworkId], references: [id])
  departmentId      String?
  department        Department?    @relation(fields: [departmentId], references: [id])
  ownerId           String?
  owner             User?          @relation("ControlOwner", fields: [ownerId], references: [id])
  assigneeId        String?
  assignee          User?          @relation("ControlAssignee", fields: [assigneeId], references: [id])
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  evidences         Evidence[]
  exceptions        Exception[]
}

// Processes
model Process {
  id           String      @id @default(cuid())
  processCode  String      @unique
  name         String
  description  String?
  processType  String      @default("Primary") // Primary, Management, Supporting
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  ownerId      String?
  owner        User?       @relation("ProcessOwner", fields: [ownerId], references: [id])
  status       String      @default("Active")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Governance - Policies, Standards, Procedures
model Policy {
  id            String      @id @default(cuid())
  name          String
  version       String      @default("1.0")
  documentType  String      @default("Policy") // Policy, Standard, Procedure
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  status        String      @default("Draft") // Not Uploaded, Draft, Approved, Needs Review, Published
  effectiveDate DateTime?
  reviewDate    DateTime?
  content       String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// Evidence
model Evidence {
  id           String      @id @default(cuid())
  name         String
  description  String?
  frameworkId  String?
  framework    Framework?  @relation(fields: [frameworkId], references: [id])
  controlId    String?
  control      Control?    @relation(fields: [controlId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  assigneeId   String?
  assignee     User?       @relation("EvidenceAssignee", fields: [assigneeId], references: [id])
  dueDate      DateTime?
  status       String      @default("Pending") // Pending, Submitted, Approved, Rejected, Overdue
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Exceptions
model Exception {
  id           String      @id @default(cuid())
  title        String
  description  String?
  exceptionType String     // Control, Compliance, Policy
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  controlId    String?
  control      Control?    @relation(fields: [controlId], references: [id])
  status       String      @default("Pending") // Pending, Approved, Authorized, Closed, Overdue
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// ==================== ASSET MANAGEMENT MODULE ====================

// Asset Category (Top-level categories: Hardware, Software, Data, etc.)
model AssetCategory {
  id            String             @id @default(cuid())
  name          String             @unique
  description   String?
  status        String             @default("Active") // Active, Inactive
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  subCategories AssetSubCategory[]
  assets        Asset[]
}

// Asset Sub Category (e.g., Server, Firewall under Hardware)
model AssetSubCategory {
  id                      String                   @id @default(cuid())
  name                    String
  description             String?
  categoryId              String
  category                AssetCategory            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  status                  String                   @default("Active") // Active, Inactive
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  assets                  Asset[]
  assetCIAClassifications AssetCIAClassification[]

  @@unique([name, categoryId])
}

// Asset Group (Logical groupings: Security Tools, Payment Systems, etc.)
model AssetGroup {
  id                      String                   @id @default(cuid())
  name                    String                   @unique
  description             String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  assets                  Asset[]
  assetCIAClassifications AssetCIAClassification[]
}

// CIA Rating Levels (for Confidentiality, Integrity, Availability)
model CIARating {
  id        String   @id @default(cuid())
  type      String   // Confidentiality, Integrity, Availability
  label     String   // high, medium, low
  value     Int      // Score value (e.g., 10, 5, 1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, label])
}

// Asset Sensitivity Levels
model AssetSensitivity {
  id          String   @id @default(cuid())
  name        String   @unique // Public, Internal, Confidential, Restricted
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]
}

// Asset CIA Classification (Links Sub Category + Group with CIA ratings)
model AssetCIAClassification {
  id                    String           @id @default(cuid())
  subCategoryId         String
  subCategory           AssetSubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)
  groupId               String
  group                 AssetGroup       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  confidentiality       String           @default("low") // high, medium, low
  confidentialityScore  Int              @default(1)
  integrity             String           @default("low") // high, medium, low
  integrityScore        Int              @default(1)
  availability          String           @default("low") // high, medium, low
  availabilityScore     Int              @default(0)
  assetCriticality      String           @default("low") // high, medium, low
  assetCriticalityScore Int              @default(1)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([subCategoryId, groupId])
}

// Asset Lifecycle Status
model AssetLifecycleStatus {
  id          String   @id @default(cuid())
  name        String   @unique // Active, In Use, Needs Maintenance, Retired
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]
}

// Asset Classification (Legacy - keeping for backwards compatibility)
model AssetClassification {
  id          String   @id @default(cuid())
  name        String   @unique // Critical, High, Medium, Low
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]
}

// Assets
model Asset {
  id                String                @id @default(cuid())
  assetId           String                @unique
  name              String
  description       String?
  // Category hierarchy
  categoryId        String?
  category          AssetCategory?        @relation(fields: [categoryId], references: [id])
  subCategoryId     String?
  subCategory       AssetSubCategory?     @relation(fields: [subCategoryId], references: [id])
  groupId           String?
  group             AssetGroup?           @relation(fields: [groupId], references: [id])
  // Legacy asset type (keeping for backwards compatibility)
  assetType         String?               // Hardware, Software, Information, People, Services, Facility
  // Department and ownership
  departmentId      String?
  department        Department?           @relation(fields: [departmentId], references: [id])
  ownerId           String?
  owner             User?                 @relation("AssetOwner", fields: [ownerId], references: [id])
  custodianId       String?
  custodian         User?                 @relation("AssetCustodian", fields: [custodianId], references: [id])
  // Classification
  classificationId  String?
  classification    AssetClassification?  @relation(fields: [classificationId], references: [id])
  sensitivityId     String?
  sensitivity       AssetSensitivity?     @relation(fields: [sensitivityId], references: [id])
  // Lifecycle
  lifecycleStatusId String?
  lifecycleStatus   AssetLifecycleStatus? @relation(fields: [lifecycleStatusId], references: [id])
  status            String                @default("Active") // Legacy status field
  // Asset details
  value             Float?
  location          String?
  acquisitionDate   DateTime?
  nextReviewDate    DateTime?
  // Timestamps
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
}

// ==================== RISK MANAGEMENT MODULE ====================

// Risk Categories
model RiskCategory {
  id          String   @id @default(cuid())
  name        String   @unique // Strategic, Operational, Financial, Compliance, IT/Cyber, Reputational
  description String?
  color       String?  // Color code for UI display
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       Risk[]
}

// Risk Types
model RiskType {
  id          String   @id @default(cuid())
  name        String   @unique // Inherent, Residual, Target
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       Risk[]
}

// Risk Threats
model RiskThreat {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       RiskThreatMapping[]
}

// Risk Vulnerabilities
model RiskVulnerability {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       RiskVulnerabilityMapping[]
}

// Risk Causes
model RiskCause {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  risks       RiskCauseMapping[]
}

// Risk-Threat Mapping (many-to-many)
model RiskThreatMapping {
  id        String     @id @default(cuid())
  riskId    String
  risk      Risk       @relation(fields: [riskId], references: [id], onDelete: Cascade)
  threatId  String
  threat    RiskThreat @relation(fields: [threatId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([riskId, threatId])
}

// Risk-Vulnerability Mapping (many-to-many)
model RiskVulnerabilityMapping {
  id              String            @id @default(cuid())
  riskId          String
  risk            Risk              @relation(fields: [riskId], references: [id], onDelete: Cascade)
  vulnerabilityId String
  vulnerability   RiskVulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
  createdAt       DateTime          @default(now())

  @@unique([riskId, vulnerabilityId])
}

// Risk-Cause Mapping (many-to-many)
model RiskCauseMapping {
  id        String    @id @default(cuid())
  riskId    String
  risk      Risk      @relation(fields: [riskId], references: [id], onDelete: Cascade)
  causeId   String
  cause     RiskCause @relation(fields: [causeId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())

  @@unique([riskId, causeId])
}

// Risks
model Risk {
  id                  String        @id @default(cuid())
  riskId              String        @unique
  name                String
  description         String?
  riskSources         String?       // Sources of the risk
  categoryId          String?
  category            RiskCategory? @relation(fields: [categoryId], references: [id])
  typeId              String?
  type                RiskType?     @relation(fields: [typeId], references: [id])
  departmentId        String?
  department          Department?   @relation(fields: [departmentId], references: [id])
  ownerId             String?
  owner               User?         @relation("RiskOwner", fields: [ownerId], references: [id])
  // Assessment scores
  likelihood          Int           @default(1) // 1-5 scale
  impact              Int           @default(1) // 1-5 scale
  riskScore           Int           @default(1) // likelihood * impact
  riskRating          String        @default("Low") // Catastrophic, Very High, High, Medium, Low
  // Inherent, Residual, Target risk scores
  inherentLikelihood  Int?
  inherentImpact      Int?
  inherentRiskScore   Int?
  residualLikelihood  Int?
  residualImpact      Int?
  residualRiskScore   Int?
  targetLikelihood    Int?
  targetImpact        Int?
  targetRiskScore     Int?
  // Response
  status              String        @default("Open") // Awaiting Approval, Pending Assessment, Open, In Progress, Closed
  responseStrategy    String?       // Treat, Transfer, Avoid, Accept
  treatmentPlan       String?
  treatmentDueDate    DateTime?
  treatmentStatus     String?       // Not Started, In Progress, Completed
  // Timestamps
  identifiedDate      DateTime      @default(now())
  lastAssessmentDate  DateTime?
  nextReviewDate      DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  // Relations
  threats             RiskThreatMapping[]
  vulnerabilities     RiskVulnerabilityMapping[]
  causes              RiskCauseMapping[]
  assessments         RiskAssessment[]
  responses           RiskResponse[]
  activityLogs        RiskActivityLog[]
}

// Risk Assessment Records
model RiskAssessment {
  id                 String   @id @default(cuid())
  assessmentId       String   @unique
  riskId             String
  risk               Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  assessmentType     String   @default("Periodic") // Initial, Periodic, Ad-hoc
  assessorName       String?
  // Assessment scores
  likelihood         Int      @default(1)
  likelihoodRationale String?
  impact             Int      @default(1)
  impactRationale    String?
  riskScore          Int      @default(1)
  riskRating         String   @default("Low")
  // Identified items during assessment
  threatsIdentified  String?  // JSON array of threat names
  vulnerabilitiesIdentified String? // JSON array of vulnerability names
  causesIdentified   String?  // JSON array of cause names
  // Recommendations
  recommendations    String?
  notes              String?
  // Status
  status             String   @default("Draft") // Draft, Submitted, Approved, Rejected
  assessmentDate     DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Risk Response Records
model RiskResponse {
  id               String    @id @default(cuid())
  responseId       String    @unique
  riskId           String
  risk             Risk      @relation(fields: [riskId], references: [id], onDelete: Cascade)
  responseType     String    @default("Mitigate") // Mitigate, Transfer, Accept, Avoid
  actionTitle      String
  actionDescription String?
  assignee         String?
  dueDate          DateTime?
  status           String    @default("Open") // Open, In Progress, Completed, Overdue
  completionDate   DateTime?
  effectivenessRating Int?   // 1-5 scale
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// Risk Settings (configurable parameters)
model RiskSetting {
  id          String   @id @default(cuid())
  category    String   // likelihood_scale, impact_scale, rating_matrix, appetite, frequency
  key         String
  value       String   // JSON value
  label       String?
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([category, key])
}

// Risk Activity Log (for tracking all risk-related activities)
model RiskActivityLog {
  id          String   @id @default(cuid())
  riskId      String
  risk        Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  activity    String   // Created, Updated, Deleted, Status Changed, Assessment Added, etc.
  description String?  // Detailed description of what changed
  actor       String   // User who performed the action
  actorId     String?  // User ID if available
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())
}

// ==================== INTERNAL AUDIT MODULE ====================

// Audits
model Audit {
  id           String         @id @default(cuid())
  auditId      String         @unique
  name         String
  description  String?
  auditType    String?        // Internal, External
  departmentId String?
  department   Department?    @relation(fields: [departmentId], references: [id])
  auditorId    String?
  auditor      User?          @relation("Auditor", fields: [auditorId], references: [id])
  status       String         @default("Planned") // Planned, In Progress, Completed, Cancelled
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  findings     AuditFinding[]
}

// Audit Findings
model AuditFinding {
  id          String   @id @default(cuid())
  findingId   String   @unique
  title       String
  description String?
  auditId     String?
  audit       Audit?   @relation(fields: [auditId], references: [id])
  severity    String   @default("Medium") // High, Medium, Low
  status      String   @default("Open") // Open, In Progress, Closed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  capas       CAPA[]
}

// CAPA (Corrective and Preventive Actions)
model CAPA {
  id          String        @id @default(cuid())
  capaId      String        @unique
  title       String
  description String?
  findingId   String?
  finding     AuditFinding? @relation(fields: [findingId], references: [id])
  actionType  String        @default("Corrective") // Corrective, Preventive
  status      String        @default("Open") // Open, In Progress, Closed, Overdue
  dueDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// ==================== AUDIT LOGS ====================

model AuditLog {
  id          String   @id @default(cuid())
  changeType  String // CREATE, UPDATE, DELETE
  entityType  String // e.g., Control, User, Risk
  entityId    String
  userId      String?
  userName    String?
  changes     String? // JSON string of old/new values
  createdAt   DateTime @default(now())
}
